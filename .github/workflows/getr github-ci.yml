name: CI/CD Pipeline for Dockerized App

on:
  push:
    branches:
      - master  # Trigger the pipeline on push to the master branch

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Using self-hosted runner

    steps:
    # Step 1: Checkout the code from the repository
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up Docker Buildx (for multi-platform builds)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # Step 3: Log in to Docker Hub using GitHub Secrets
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub username from GitHub Secrets
        password: ${{ secrets.DOCKER_PASSWORD }}  # Docker password from GitHub Secrets

    # Step 4: Build the Docker image from your Dockerfile
    - name: Build Docker image
      run: |
        docker build -t soumith362/bckimage:latest .

    # Step 5: Push the Docker image to Docker Hub
    - name: Push Docker image to Docker Hub
      run: |
        docker push soumith362/bckimage:latest

    # Step 6: Deploy Docker container on EC2 instance
    - name: Deploy Docker container on EC2
      env:
        HOST: 18.208.167.204  # EC2 Public IP
        USERNAME: ubuntu  # EC2 SSH username (adjust if different)
        PASSWORD: ${{ secrets.EC2_PASSWORD }}  # EC2 password from GitHub Secrets
      run: |
        # Install sshpass if not installed
        sudo apt-get update && sudo apt-get install -y sshpass

        # SSH into EC2 and deploy the Docker container
        sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST << EOF
        # Pull the Docker image from Docker Hub
        docker pull soumith362/bckimage:latest

        # Stop and remove any existing container (if running)
        docker stop my-app || true
        docker rm my-app || true

        # Run the new Docker container
        docker run -d --name my-app -p 80:80 soumith362/bckimage:latest
        EOF
